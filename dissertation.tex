%% 
%% ACS project dissertation template. 
%% 
%% Currently designed for printing two-sided, but if you prefer to 
%% print single-sided just remove ",twoside,openright" from the 
%% \documentclass[] line below. 
%%
%%
%%   SMH, May 2010. 

\newcommand{\wordcount}{\input{|"make count"}}

\documentclass[a4paper,12pt,twoside,openright]{report}
%TC:ignore

%%
%% EDIT THE BELOW TO CUSTOMIZE
%%

\def\authorname{Alexander\ Harri\ Bell-Thomas\xspace}
\def\authorcollege{Jesus College\xspace}
\def\authoremail{Alexander.Bell-Thomas@cl.cam.ac.uk}
\def\dissertationtitle{Trusted Reference Monitors for Linux using Intel SGX Enclaves}



%\usepackage[dvips]{epsfig,graphics} 
\usepackage{
  epsfig,
  graphicx,
  verbatim,
  parskip,
  tabularx,
  setspace,
  xspace,
  geometry,
  amssymb,
  mathtools,
  url,
  xcolor,
  relsize,
  backref,
  multirow,
  booktabs,
  array,
  makecell,
  caption
}
\usepackage[backref=page]{hyperref}
\usepackage[tt=false]{libertine}
\usepackage{multirow}
\usepackage{minted}
\usepackage[mathscr]{euscript}

\renewcommand*{\backref}[1]{}
\renewcommand*{\backrefalt}[4]{%
    \ifcase #1 (Not cited.)%
    \or        (Cited on page~#2.)%
    \else      (Cited on pages~#2.)%
    \fi}
\setminted{
    linenos=true,
    autogobble,
}
\newenvironment{longlisting}{\captionsetup{type=listing}}{}
\setcounter{secnumdepth}{3}
\setcounter{tocdepth}{2}

% Special preorder symbol.
\newcommand{\sprecsim}{\kern0.5ex\vcenter{\hbox{\scalebox{0.75}{$\textstyle\precsim\,$}}}\kern0.5ex}
\newcommand{\sqin}{%
  \mathrel{\vphantom{\sqsubset}\text{%
    \mathsurround=0pt
    \ooalign{$\sqsubset$\cr$-$\cr}%
  }}%
}


%% START OF DOCUMENT
\begin{document}


%% FRONTMATTER (TITLE PAGE, DECLARATION, ABSTRACT, ETC) 
\pagestyle{empty}
\singlespacing
\newgeometry{margin=1.4in}
\input{titlepage}
\restoregeometry
\onehalfspacing
\input{declaration}
\singlespacing
\input{abstract}

\pagenumbering{roman}
\setcounter{page}{0}
\pagestyle{plain}
\tableofcontents
\addcontentsline{toc}{section}{\listfigurename}
\listoffigures
\addcontentsline{toc}{section}{\listtablename}
\listoftables

\onehalfspacing

%TC:endignore
%% START OF MAIN TEXT 
\raggedbottom

\chapter{Introduction}
\pagenumbering{arabic} 
\setcounter{page}{1} 
\input{chapters/introduction}

\chapter{Background} 
\label{sec:background}
\input{chapters/background}

\chapter{Related Work} 
\label{sec:related}
\input{chapters/related}

\chapter{\textsc{Citadel}}
\label{sec:design}
\input{chapters/design}

\chapter{Evaluation} 
\label{sec:eval}
\input{chapters/evaluation}

\chapter{Conclusions}
\label{sec:conclusion}
\input{chapters/conclusion}

%TC:ignore

\appendix
\singlespacing

\chapter{PID Tampering: Proof of Concept}
\label{appendix:pid-tampering}

\begin{listing}[h]
\begin{minted}[fontsize=\small]{c}
static void* retrieve_symbol(const char *sym) { 
   static unsigned long faddr = 0;  

   // Compare kernel symbol with query.
   int symcmp(void* data, const char* sym, struct module* mod, 
              unsigned long addr) { 
      if(!strcmp((char*)data, sym)) { 
         faddr = addr; 
         return 1; 
      } 
      else return 0; 
   }; 

   kallsyms_on_each_symbol(symcmp, (void*)sym); 
   return (void*)faddr; 
} 


static asmlinkage void (*_change_pid)
      (struct task_struct *task, enum pid_type type, struct pid *pid);
static asmlinkage struct pid* (*_alloc_pid)(struct pid_namespace *ns);

static ssize_t change_pid(void)
{
    struct pid* newpid = _alloc_pid(task_active_pid_ns(current));
    _change_pid(current, PIDTYPE_PID, newpid);
    /* current->pid has changed. */
}

static int __init module_init(void)
{
    _change_pid = retrieve_symbol("change_pid");
    _alloc_pid = retrieve_symbol("alloc_pid");
    /* ... */
    /* On SysFS call execute change_pid(void) */
    return 0;
}

\end{minted}
\caption{Outline for a proof of concept kernel module to change a process's PID.}
\end{listing}

\bibliographystyle{unsrt} 
\bibliography{references} 

%TC:endignore
\end{document}
